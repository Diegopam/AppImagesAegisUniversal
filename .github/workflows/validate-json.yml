name: Validate and Auto-Merge App Store JSON

on:
  pull_request:
    branches: [ "main" ]
    paths:
      - 'apps.json'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install validator dependencies
        run: |
          npm init -y
          npm install ajv ajv-formats

      - name: Validate apps.json against schema
        id: validate
        run: |
          node <<'EOF'
          const fs = require("fs");
          const Ajv = require("ajv");
          const addFormats = require("ajv-formats");

          const ajv = new Ajv({ allErrors: true });
          addFormats(ajv);

          const schema = JSON.parse(
            fs.readFileSync("schema/app-store.schema.json", "utf8")
          );

          const data = JSON.parse(
            fs.readFileSync("apps.json", "utf8")
          );

          const validate = ajv.compile(schema);
          const valid = validate(data);

          if (!valid) {
            console.error("âŒ JSON invÃ¡lido:");
            console.error(JSON.stringify(validate.errors, null, 2));
            process.exit(1);
          }

          console.log("âœ… JSON vÃ¡lido! Tudo certo.");
          console.log(`ðŸ“¦ Total de apps: ${data.apps.length}`);
          EOF

      - name: Merge PR (if validation passed)
        if: success()
        run: |
          # Merge direto apÃ³s validaÃ§Ã£o bem-sucedida
          gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch || echo "Merge pode precisar de configuraÃ§Ã£o nas branch protection rules"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR (Success)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **ValidaÃ§Ã£o aprovada!** O JSON estÃ¡ correto e serÃ¡ mergeado automaticamente.\n\nðŸŽ‰ Obrigado por contribuir com a AppImage Store!'
            })

      - name: Comment on PR (Failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **ValidaÃ§Ã£o falhou!** O JSON contÃ©m erros.\n\nPor favor, verifique se seu app segue o schema corretamente.'
            })
